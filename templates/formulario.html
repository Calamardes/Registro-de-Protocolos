<script>
    let jerarquia = {};

    async function cargarJerarquia() {
        const response = await fetch("/jerarquia");
        jerarquia = await response.json();
        poblarSelect(jerarquia, 1);
    }

    function poblarSelect(data, nivel) {
        const select = document.getElementById(`nivel${nivel}`);
        select.innerHTML = '<option value="">-- Seleccionar --</option>';

        for (const codigo in data) {
            const descripcion = data[codigo]?.descripcion || "";
            const option = document.createElement("option");
            option.value = codigo;
            option.textContent = `${codigo} ${descripcion}`;
            select.appendChild(option);
        }

        const sinItem = document.createElement("option");
        sinItem.value = "Sin_Item_N" + nivel;
        sinItem.textContent = "-- No Item --";
        select.appendChild(sinItem);

        for (let i = nivel + 1; i <= 5; i++) {
            const nextSelect = document.getElementById(`nivel${i}`);
            nextSelect.innerHTML = '<option value="">-- Seleccionar --</option><option value="Sin_Item_N' + i + '">-- No Item --</option>';
        }
    }

    function obtenerRutaHasta(nivel) {
        let ruta = [];
        for (let i = 1; i <= nivel; i++) {
            let val = document.getElementById(`nivel${i}`).value;
            if (val && !val.startsWith("Sin_Item")) ruta.push(val);
        }
        return ruta;
    }

    function buscarSubitems(ruta) {
        let actual = jerarquia;
        for (let cod of ruta) {
            actual = actual[cod]?.subitems || {};
        }
        return actual;
    }

    function setupEventos() {
        for (let nivel = 1; nivel < 5; nivel++) {
            const select = document.getElementById(`nivel${nivel}`);
            select.addEventListener("change", () => {
                const ruta = obtenerRutaHasta(nivel);
                const subitems = buscarSubitems(ruta);
                poblarSelect(subitems, nivel + 1);
            });
        }
    }

    cargarJerarquia();
    setupEventos();
</script>
