</form>

<!-- Tabla resumen -->
<div class="row mt-4">
    <div class="col-12">
        <div class="form-section">
            <h4 class="mb-3">Resumen de Protocolos</h4>
            <table class="table table-bordered table-hover table-dark align-middle">
                <thead class="table-light text-dark">
                    <tr>
                        <th>N¬∞ Protocolo</th>
                        <th>TAG</th>
                        <th>PK Inicio</th>
                        <th>PK Fin</th>
                        <th>Estado</th>
                        <th>Fecha Env√≠o</th>
                        <th>Fecha Aprobaci√≥n</th>
                        <th style="text-align: center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>00001</td>
                        <td>RETX-PK17</td>
                        <td>17+200</td>
                        <td>17+400</td>
                        <td><span class="badge bg-success">Aprobado</span></td>
                        <td>2025-07-01</td>
                        <td>2025-07-03</td>
                        <td class="text-center">
                            <button class="btn btn-outline-info btn-sm">üîç Ver</button>
                        </td>
                    </tr>
                    <tr>
                        <td>00002</td>
                        <td>RETX-PK18</td>
                        <td>17+400</td>
                        <td>17+600</td>
                        <td><span class="badge bg-warning text-dark">Pendiente</span></td>
                        <td>2025-07-04</td>
                        <td>-</td>
                        <td class="text-center">
                            <button class="btn btn-outline-info btn-sm">üîç Ver</button>
                        </td>
                    </tr>
                    <tr>
                        <td>00003</td>
                        <td>RETX-PK19</td>
                        <td>17+600</td>
                        <td>17+800</td>
                        <td><span class="badge bg-danger">Rechazado</span></td>
                        <td>2025-07-05</td>
                        <td>2025-07-06</td>
                        <td class="text-center">
                            <button class="btn btn-outline-info btn-sm">üîç Ver</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>

<script>
    let jerarquia = {};

    async function cargarJerarquia() {
        const response = await fetch("/jerarquia");
        jerarquia = await response.json();
        poblarSelect(jerarquia, 1);
    }

    function poblarSelect(data, nivel) {
        const select = document.getElementById(`nivel${nivel}`);
        select.innerHTML = '<option value="">-- Seleccionar --</option>';

        for (const codigo in data) {
            const descripcion = data[codigo]?.descripcion || "";
            const option = document.createElement("option");
            option.value = `${codigo} ${descripcion}`;
            option.textContent = `${codigo} ${descripcion}`;
            select.appendChild(option);
        }

        const sinItem = document.createElement("option");
        sinItem.value = `Sin_Item_N${nivel}`;
        sinItem.textContent = "-- No Item --";
        select.appendChild(sinItem);

        for (let i = nivel + 1; i <= 5; i++) {
            const nextSelect = document.getElementById(`nivel${i}`);
            nextSelect.innerHTML = '<option value="">-- Seleccionar --</option><option value="Sin_Item_N' + i + '">-- No Item --</option>';
        }
    }

    function obtenerRutaHasta(nivel) {
        let ruta = [];
        for (let i = 1; i <= nivel; i++) {
            let val = document.getElementById(`nivel${i}`).value;
            if (val && !val.startsWith("Sin_Item")) ruta.push(val.split(" ")[0]);
        }
        return ruta;
    }

    function buscarSubitems(ruta) {
        let actual = jerarquia;
        for (let cod of ruta) {
            actual = actual[cod]?.subitems || {};
        }
        return actual;
    }

    function setupEventos() {
        for (let nivel = 1; nivel < 5; nivel++) {
            const select = document.getElementById(`nivel${nivel}`);
            select.addEventListener("change", () => {
                const ruta = obtenerRutaHasta(nivel);
                const subitems = buscarSubitems(ruta);
                poblarSelect(subitems, nivel + 1);
            });
        }
    }

    cargarJerarquia();
    setupEventos();
</script>
</body>
</html>
