<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>GeoProtocolos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f3f4f6;
      font-family: 'Inter', sans-serif;
    }

    .scrollable-table {
      max-height: 400px;
      overflow-y: auto;
    }

    table.table {
      margin: 0;
      border-collapse: collapse;
      table-layout: fixed;
      width: 100%;
    }

    table th,
    table td {
      font-size: 12.5px;
      padding: 6px;
      text-align: center;
      vertical-align: middle;
      white-space: nowrap;
      resize: horizontal;
      overflow: hidden;
    }

    table thead th {
      background-color: #e2e8f0;
      position: sticky;
      top: 0;
      z-index: 2;
      cursor: pointer;
    }

    .form-control,
    .form-select {
      font-size: 13px;
      height: auto;
    }

    .form-section {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid #e2e8f0;
    }

    .btn-database {
      background-color: #0ea5e9;
      color: #fff;
      font-weight: 500;
    }

    .btn-database:hover {
      background-color: #0284c7;
    }

    input.table-filter {
      width: 100%;
      font-size: 12px;
      padding: 2px;
    }

    #global-search {
      margin-bottom: 10px;
      font-size: 13px;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <h2 class="mb-3">Registro de Protocolos</h2>

  <div class="form-section">
    <div class="row">
      <div class="col-md-6" style="min-height: 33vh;">
        <h5>Selección Jerárquica</h5>
        <div class="row g-2">
          {% for i in range(1, 6) %}
          <div class="col-12">
            <select class="form-select" id="nivel{{ i }}">
              <option value="">Nivel {{ i }}</option>
            </select>
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="col-md-6">
        <h5>Datos del Protocolo</h5>
        <div class="row g-2">
          <div class="col-6"><input type="text" class="form-control" placeholder="RP"></div>
          <div class="col-6"><input type="text" class="form-control" placeholder="Protocolo"></div>
          <div class="col-6">
            <select class="form-select">
              <option value="">Estado</option>
              <option value="Aprobado">Aprobado</option>
              <option value="Pendiente">Pendiente</option>
              <option value="Rechazado">Rechazado</option>
            </select>
          </div>
          <div class="col-6"><input type="text" class="form-control" placeholder="Capa"></div>
          <div class="col-6"><input type="text" class="form-control" placeholder="PK Inicio"></div>
          <div class="col-6"><input type="text" class="form-control" placeholder="PK Fin"></div>
          <div class="col-6">
            <select class="form-select">
              <option value="">Lado</option>
              <option value="Izquierdo">Izquierdo</option>
              <option value="Derecho">Derecho</option>
              <option value="Completa">Completa</option>
            </select>
          </div>
          <div class="col-6"><input type="text" class="form-control" placeholder="Espesor"></div>
          <div class="col-6"><input type="text" class="form-control" placeholder="TAG"></div>
          <div class="col-6"><input type="date" class="form-control" placeholder="Fecha Envío"></div>
          <div class="col-6"><input type="date" class="form-control" placeholder="Fecha Aprobación"></div>
          <div class="col-12"><textarea class="form-control" rows="2" placeholder="Observaciones"></textarea></div>
        </div>
        <div class="mt-3 text-end">
          <button class="btn btn-database">💾 Consolidar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="form-section">
    <h5 class="mb-2">Resumen de Protocolos</h5>
    <div class="d-flex justify-content-between align-items-center mb-2">
      <input id="global-search" class="form-control w-50" placeholder="🔍 Buscar en toda la tabla">
      <span><strong>Total:</strong> <span id="total-count">0</span></span>
    </div>
    <div class="scrollable-table">
      <table class="table table-bordered table-hover table-sm" id="tabla-protocolos">
        <thead>
          <tr id="encabezados">
            <th>ID</th><th>RP</th><th>Protocolo</th><th>Estado</th><th>Nivel 1</th><th>Nivel 2</th>
            <th>Nivel 3</th><th>Nivel 4</th><th>Nivel 5</th><th>PK Inicio</th><th>PK Fin</th>
            <th>Capa</th><th>Lado</th><th>Espesor</th><th>TAG</th><th>Envío</th><th>Aprobación</th><th>Obs</th>
          </tr>
          <tr>
            {% for i in range(18) %}
            <th><input class="table-filter" data-col="{{ i }}" onkeyup="filtrarColumna(this)"></th>
            {% endfor %}
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const tabla = document.getElementById('tabla-protocolos').getElementsByTagName('tbody')[0];
  const totalContador = document.getElementById('total-count');

  document.querySelector('.btn-database').addEventListener('click', () => {
    const campos = document.querySelectorAll('.form-control, .form-select');
    const datos = Array.from(campos).map(e => e.value.trim());

    // Validación básica
    if (datos.filter(d => d !== "").length < 10) {
      alert("Por favor completa los campos obligatorios.");
      return;
    }

    const fila = document.createElement('tr');
    const id = tabla.rows.length + 1;
    const niveles = [...Array(5).keys()].map(i => document.getElementById(`nivel${i + 1}`)?.value || "");
    const valores = [id, ...datos.slice(0, 2), datos[2], ...niveles, datos[4], datos[5], datos[3], datos[6], datos[7], datos[8], datos[9], datos[10], datos[11]];

    valores.forEach(valor => {
      const celda = document.createElement('td');
      celda.textContent = valor;
      celda.contentEditable = true;
      celda.title = valor;
      celda.addEventListener("click", () => {
        const r = document.createRange();
        r.selectNodeContents(celda);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(r);
      });
      fila.appendChild(celda);
    });

    tabla.appendChild(fila);
    totalContador.textContent = tabla.rows.length;
  });

  // Filtro por columna
  function filtrarColumna(input) {
    const col = input.getAttribute("data-col");
    const valor = input.value.toLowerCase();
    for (let row of tabla.rows) {
      const texto = row.cells[col]?.textContent.toLowerCase() || "";
      row.style.display = texto.includes(valor) ? "" : "none";
    }
  }

  // Búsqueda global
  document.getElementById("global-search").addEventListener("keyup", function () {
    const val = this.value.toLowerCase();
    for (let row of tabla.rows) {
      row.style.display = Array.from(row.cells).some(td => td.textContent.toLowerCase().includes(val)) ? "" : "none";
    }
  });

  // Ordenar columnas
  document.querySelectorAll("#encabezados th").forEach((th, i) => {
    th.addEventListener("click", () => {
      const filas = Array.from(tabla.rows);
      const asc = th.classList.toggle("asc");
      filas.sort((a, b) => {
        const t1 = a.cells[i].textContent;
        const t2 = b.cells[i].textContent;
        return asc ? t1.localeCompare(t2) : t2.localeCompare(t1);
      });
      filas.forEach(f => tabla.appendChild(f));
    });
  });
</script>
</body>
</html>
